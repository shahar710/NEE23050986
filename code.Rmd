---
title: "code"
author: "Shahar Chaikin"
date: "7/20/2023"
output: html_document
---

This code presents the analyses used in NATECOLEVOL-23050986

#Packages
```{r}
library(tidyverse)
library(glmmTMB)
```

#Load the data
```{r}
data=read.csv("data.csv")
```

Set WD
```{r}
setwd("C:\\Users\\Belmaker-Video\\Desktop\\Shahar Chaikin\\on going research\\Depth and Biodiversity\\data\\abundance at range edge\\R\\organized_codes\\code_to_publish\\NATECOLEVOL-23050986")
```

#main effect
The relationship between population trends and range shift velocities.
Population trends (slopes) based on linear models with scaled abundance.
```{r}
test_main_effect=glmmTMB(data=data,
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_effect)
MuMIn::r.squaredGLMM(test_main_effect)
#Model diagnostics
sjPlot::plot_model(test_main_effect,type="diag")
sjPlot::plot_model(test_main_effect,type="eff",show.data = T)
```

##remove extreme range shift velocities
```{r}
#shift of minimum sm
quantile(data$shift_of_min_sm)[[4]]
IQR=quantile(data$shift_of_min_sm)[[4]]-quantile(data$shift_of_min_sm)[[2]]
min=quantile(data$shift_of_min_sm)[[2]]-(IQR*1.5)
max=quantile(data$shift_of_min_sm)[[4]]+(IQR*1.5)

test_main_effect_rm_ex_sh=glmmTMB::glmmTMB(data=data %>% filter(shift_of_min_sm<=max & shift_of_min_sm>=min),
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n) 
#Model Summary
summary(test_main_effect_rm_ex_sh)
MuMIn::r.squaredGLMM(test_main_effect_rm_ex_sh)
#Model diagnostics
sjPlot::plot_model(test_main_effect_rm_ex_sh,type="diag")
sjPlot::plot_model(test_main_effect_rm_ex_sh,type="eff")
```

##Leading edge range shift velocities
```{r}
data_leading=read.csv("data_leading.csv")

test_main_effect_leading=glmmTMB(data=data_leading,
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_effect_leading)
MuMIn::r.squaredGLMM(test_main_effect_leading)
#Model diagnostics
sjPlot::plot_model(test_main_effect_leading,type="diag")
sjPlot::plot_model(test_main_effect_leading,type="eff",show.data = T)
```


##Trailing edge range shift velocities
```{r}
data_trailing=read.csv("data_trailing.csv")

test_main_effect_trailing=glmmTMB(data=data_trailing,
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_effect_trailing)
MuMIn::r.squaredGLMM(test_main_effect_trailing)
#Model diagnostics
sjPlot::plot_model(test_main_effect_trailing,type="diag")
sjPlot::plot_model(test_main_effect_trailing,type="eff",show.data = T)
```

##species level
```{r}
#Create species level shift with stat. summary
species_level_shifts=data %>% 
  group_by(species) %>% 
  summarise(mean_shift_of_min_sm=mean(shift_of_min_sm),
            n=n(),
            sd=sd(shift_of_min_sm),
            se=(sd/sqrt(n)),
            moe=1.96*se,
            ci_high_shift=mean_shift_of_min_sm+moe,
            ci_low_shift=mean_shift_of_min_sm-moe)

#Create species level data
data_sp_level=data %>% 
  group_by(species,family) %>% 
  summarise(n_es=n(),
            mean_es=mean(slope),#weighted.mean(slope,w =n),
            sd_es=sd(slope),
            se_es=sd_es/sqrt(n_es),
            moe_es=se_es*1.96,
            ci_high_es=mean_es+moe_es,
            ci_low_es=mean_es-moe_es)  %>%
  inner_join(species_level_shifts,by="species") %>% 
  ungroup() %>% 
  mutate(across(c(4:10,12:16), round, 3),
         sqrt_n_es=sqrt(n_es))

#Model
#Model
test_sp_level=glmmTMB::glmmTMB(data=data_sp_level,
formula=mean_es~mean_shift_of_min_sm+
  (1|family),
family = 'gaussian',
weights =sqrt_n_es) #weights = 1/se_slope_corr
#Model Summary
summary(test_sp_level)
MuMIn::r.squaredGLMM(test_sp_level)
#Model diagnostics
sjPlot::plot_model(test_sp_level,type="diag")
sjPlot::plot_model(test_sp_level,type="eff",show.data = T)
```

##conservative model
```{r}
#WEIGHTING VIA sqrt_inverse_se_pois
test_main_conservative=glmmTMB::glmmTMB(
  data=data %>% 
    filter(BioShifts_prab%in%"ABUND",#use BioShifts estimated from abundance data
           ABUNDANCE_TYPE%in%"Count"),#Use only BioTIME time series based on count data
formula=slope_pois~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_inverse_se_pois)
#Model Summary
summary(test_main_conservative)
MuMIn::r.squaredGLMM(test_main_conservative)
#Model diagnostics
sjPlot::plot_model(test_main_conservative,type="diag")
sjPlot::plot_model(test_main_conservative,type="eff")
```

##Ocean regions
Categorize by oceans and check
```{r}
data=data %>% 
  mutate(ocean=case_when(latitude_mean<=90 & 
                         latitude_mean>=0 &
                         longitude_mean<=20 &
                         longitude_mean>=-35~"NE. Atlantic",
                         latitude_mean<=90 & 
                         latitude_mean>=0 &
                         longitude_mean<(-35) &
                         longitude_mean>=-100~"NW. Atlantic",
                         latitude_mean<=90 & 
                         latitude_mean>=20 &
                         longitude_mean<100 &
                         longitude_mean>=-175~"NE. Pacific",
                         latitude_mean<=3 & 
                         latitude_mean>=-48 &
                         longitude_mean<=180 &
                         longitude_mean>=110~"Oceania",
                         TRUE~"Other"))

ggplot(data)+
  geom_point(aes(x=longitude_mean,y=latitude_mean,color=ocean))
```

Test
```{r}
test_main_ocean=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*ocean+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_ocean)
MuMIn::r.squaredGLMM(test_main_ocean)
#Model diagnostics
sjPlot::plot_model(test_main_ocean,type="diag")
performance::check_collinearity(test_main_ocean)
#Table with model results
sjPlot::tab_model(test_main_ocean,digits = 3)
```

