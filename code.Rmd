---
title: "code"
author: "Shahar Chaikin"
date: "7/20/2023"
output: html_document
---

This code presents the analyses used in NATECOLEVOL-23050986

#Packages
```{r}
library(tidyverse)
library(glmmTMB)
```

#Load the data
```{r}
data=read.csv("data.csv")
```

Digits
```{r}
options(scipen=999)
```

#main effect
The relationship between population trends and range shift velocities.
Population trends (slopes) based on linear models with scaled abundance.
```{r}
test_main_effect=glmmTMB(data=data,
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_effect)
MuMIn::r.squaredGLMM(test_main_effect)
#Model diagnostics
sjPlot::plot_model(test_main_effect,type="diag")
sjPlot::plot_model(test_main_effect,type="eff",show.data = T)
#AIC
AIC(test_main_effect)
```

##remove extreme range shift velocities
```{r}
#shift of minimum sm
quantile(data$shift_of_min_sm)[[4]]
IQR=quantile(data$shift_of_min_sm)[[4]]-quantile(data$shift_of_min_sm)[[2]]
min=quantile(data$shift_of_min_sm)[[2]]-(IQR*1.5)
max=quantile(data$shift_of_min_sm)[[4]]+(IQR*1.5)

test_main_effect_rm_ex_sh=glmmTMB::glmmTMB(data=data %>% filter(shift_of_min_sm<=max & shift_of_min_sm>=min),
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n) 
#Model Summary
summary(test_main_effect_rm_ex_sh)
MuMIn::r.squaredGLMM(test_main_effect_rm_ex_sh)
#Model diagnostics
sjPlot::plot_model(test_main_effect_rm_ex_sh,type="diag")
sjPlot::plot_model(test_main_effect_rm_ex_sh,type="eff")
```

##Leading edge range shift velocities
```{r}
data_leading=read.csv("data_leading.csv")

test_main_effect_leading=glmmTMB(data=data_leading,
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_effect_leading)
MuMIn::r.squaredGLMM(test_main_effect_leading)
#Model diagnostics
sjPlot::plot_model(test_main_effect_leading,type="diag")
sjPlot::plot_model(test_main_effect_leading,type="eff",show.data = T)
```


##Trailing edge range shift velocities
```{r}
data_trailing=read.csv("data_trailing.csv")

test_main_effect_trailing=glmmTMB(data=data_trailing,
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_effect_trailing)
MuMIn::r.squaredGLMM(test_main_effect_trailing)
#Model diagnostics
sjPlot::plot_model(test_main_effect_trailing,type="diag")
sjPlot::plot_model(test_main_effect_trailing,type="eff",show.data = T)
```

##species level
```{r}
#Create species level shift with stat. summary
species_level_shifts=data %>% 
  group_by(species) %>% 
  summarise(mean_shift_of_min_sm=mean(shift_of_min_sm),
            n=n(),
            sd=sd(shift_of_min_sm),
            se=(sd/sqrt(n)),
            moe=1.96*se,
            ci_high_shift=mean_shift_of_min_sm+moe,
            ci_low_shift=mean_shift_of_min_sm-moe)

#Create species level data
data_sp_level=data %>% 
  group_by(species,family) %>% 
  summarise(n_es=n(),
            mean_es=mean(slope),#weighted.mean(slope,w =n),
            sd_es=sd(slope),
            se_es=sd_es/sqrt(n_es),
            moe_es=se_es*1.96,
            ci_high_es=mean_es+moe_es,
            ci_low_es=mean_es-moe_es)  %>%
  inner_join(species_level_shifts,by="species") %>% 
  ungroup() %>% 
  mutate(across(c(4:10,12:16), round, 3),
         sqrt_n_es=sqrt(n_es))

#Model
#Model
test_sp_level=glmmTMB::glmmTMB(data=data_sp_level,
formula=mean_es~mean_shift_of_min_sm+
  (1|family),
family = 'gaussian',
weights =sqrt_n_es) #weights = 1/se_slope_corr
#Model Summary
summary(test_sp_level)
MuMIn::r.squaredGLMM(test_sp_level)
#Model diagnostics
sjPlot::plot_model(test_sp_level,type="diag")
sjPlot::plot_model(test_sp_level,type="eff",show.data = T)
```

##Replace weights
```{r}
test_main_replace_w=glmmTMB::glmmTMB(
  data=data %>% 
    mutate(sqrt_inverse_se=sqrt((1/(se_slope+0.0003)))),
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_inverse_se)
#Model Summary
summary(test_main_replace_w)
MuMIn::r.squaredGLMM(test_main_replace_w)
#Model diagnostics
sjPlot::plot_model(test_main_replace_w,type="diag")
sjPlot::plot_model(test_main_replace_w,type="eff")

```


##Abundance based range shifts model
Excluding range shift estimates that are estimated from occurrence data.
```{r}
test_main_abundance_based=glmmTMB::glmmTMB(
  data=data,#use BioShifts estimated from abundance data
formula=slope~shift_of_min_sm*BioShifts_prab+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_abundance_based)
MuMIn::r.squaredGLMM(test_main_abundance_based)
#Model diagnostics
sjPlot::plot_model(test_main_abundance_based,type="diag")
sjPlot::plot_model(test_main_abundance_based,type="int")
```


##Bioshifts data 
###Resurveyd
```{r}
test_res=glmmTMB::glmmTMB(
  data=data %>% 
    filter(BioShifts_quality %in%"RESURVEYED"),
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_res)
MuMIn::r.squaredGLMM(test_res)
#Model diagnostics
sjPlot::plot_model(test_res,type="diag")
sjPlot::plot_model(test_res,type="eff")
```

###Actual data (i.e., 'LOW')
```{r}
test_acdat=glmmTMB::glmmTMB(
  data=data%>% 
    filter(BioShifts_quality %in%"LOW"),
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_acdat)
MuMIn::r.squaredGLMM(test_acdat)
#Model diagnostics
sjPlot::plot_model(test_acdat,type="diag")
sjPlot::plot_model(test_acdat,type="eff")
```

##Ocean regions
Categorize by oceans and plot
```{r}
data=data %>% 
  mutate(ocean=case_when(latitude_mean<=90 & 
                         latitude_mean>=0 &
                         longitude_mean<=20 &
                         longitude_mean>=-35~"NE. Atlantic",
                         latitude_mean<=90 & 
                         latitude_mean>=0 &
                         longitude_mean<(-35) &
                         longitude_mean>=-100~"NW. Atlantic",
                         latitude_mean<=90 & 
                         latitude_mean>=20 &
                         longitude_mean<100 &
                         longitude_mean>=-175~"NE. Pacific",
                         latitude_mean<=3 & 
                         latitude_mean>=-48 &
                         longitude_mean<=180 &
                         longitude_mean>=110~"Oceania",
                         TRUE~"Other"))
#plot regions
ggplot(data)+
  geom_point(aes(x=longitude_mean,y=latitude_mean,color=ocean))
```

Test
```{r}
test_main_ocean=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*ocean+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_ocean)
MuMIn::r.squaredGLMM(test_main_ocean)
#Model diagnostics
sjPlot::plot_model(test_main_ocean,type="diag")
performance::check_collinearity(test_main_ocean)
#Table with model results
sjPlot::tab_model(test_main_ocean,digits = 3)
```

##Test with R^2 >= 0.5
```{r}
test_main_r2=glmmTMB::glmmTMB(data=data %>%
                                filter(r.squared>= .5),
formula=slope~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_r2)
MuMIn::r.squaredGLMM(test_main_r2)
#Model diagnostics
sjPlot::plot_model(test_main_r2,type="diag")
sjPlot::plot_model(test_main_r2,type="eff")
```

##Test percent cahnge in abundance
Population trends are based on GLMs with poisson error distribution.
```{r}
test_percent_change=glmmTMB::glmmTMB(
  data=data %>%
    filter(ABUNDANCE_TYPE%in%"Count"),
formula=ln_ratio_fitted~shift_of_min_sm+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n) 
#Model Summary
summary(test_percent_change)
MuMIn::r.squaredGLMM(test_percent_change)
#Model diagnostics
sjPlot::plot_model(test_percent_change,type="diag")
sjPlot::plot_model(test_percent_change,type="eff",
                   show.data = T)
##ggeffects
#range
data%>%
    filter(ABUNDANCE_TYPE%in%"Count") %>%
  select(shift_of_min_sm) %>% 
  pull %>% 
  range()
#predict with exp
test_percent_change_gg=ggeffects::ggpredict(test_percent_change,
                                            terms="shift_of_min_sm [-21:43 by=1]") %>% 
  mutate(exp_predicted=exp(predicted) %>% 
           round(digits=4),
         exp_conf.high=exp(conf.high)%>% 
           round(digits=4),
         exp_conf.low=exp(conf.low)%>% 
           round(digits=4)) %>% 
  select(x,exp_predicted,std.error,exp_conf.low,exp_conf.high)

ggplot()+
  geom_hline(yintercept = 1,linetype="dashed")+
    geom_vline(xintercept = 0,linetype="dashed")+
  geom_ribbon(data=test_percent_change_gg,
            aes(x=x,ymin=exp_conf.low,ymax=exp_conf.high),
            alpha=0.4)+
  geom_line(data=test_percent_change_gg,
            aes(x=x,y=exp_predicted))+
  theme_bw()+
  labs(x="Shift velocity (km/ year)",
       y= "Abundance ratio (T2/ T1)",
       title="Abundance change vs. range shift velocity")+
  theme(panel.border = element_blank(),
        axis.line.y=element_line(color='purple'),
        axis.line.x = element_line(color='#ffb20a'),
        axis.text.y=element_text(size=10),
        axis.title = element_text(size=12),
        axis.text.x = element_text(size=10),
        title = element_text(size=12))+
  geom_rug(data=data %>% 
             filter(ln_ratio_fitted<=1.94591),
           aes(x=shift_of_min_sm,y=exp(ln_ratio_fitted)),
           alpha = 0.2,
           size=.5,
           inherit.aes = FALSE)+
  scale_y_continuous(breaks=seq(0,8, by=1))+
  scale_x_continuous(breaks=seq(-20,40, by=10))
```

#Spatial and thermal position

##The effect of spatial position
```{r}
test_spat_pos=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*spatial_pos+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_spat_pos)
MuMIn::r.squaredGLMM(test_spat_pos)

#Model diagnostics
sjPlot::plot_model(test_spat_pos,type="diag")
performance::check_collinearity(test_spat_pos)
sjPlot::plot_model(test_spat_pos,type="int")
#AIC
AIC(test_spat_pos)
```

###Test hump-shaped pattern
In an extreme shift scenario, former poleward populations might become the new equatorward populations.
```{r}
test_non_linear=glmmTMB::glmmTMB(
  data=data %>%
            filter(spatial_pos>0,
                  shift_of_min_sm>0),#due to the quadratic transformation I eliminate negative shift values that cannot be backtransformed.
formula=slope~I(shift_of_min_sm^2)+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_non_linear)
MuMIn::r.squaredGLMM(test_non_linear)
#Model diagnostics
sjPlot::plot_model(test_non_linear,type="diag")
sjPlot::plot_model(test_non_linear,type="eff")
```

##the effect of thermal position
```{r}
test_therm_pos=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*thermal_pos+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_therm_pos)
MuMIn::r.squaredGLMM(test_therm_pos)
#Model diagnostics
sjPlot::plot_model(test_therm_pos,type="diag")
performance::check_collinearity(test_therm_pos)
```

#latitude, fishing, and spatiotemporal mismatches
##Pop. trends against abs. latitude
```{r}
test_abs_lat=glmmTMB::glmmTMB(data=data,
formula=slope~abs_latitude_mean+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_abs_lat)
MuMIn::r.squaredGLMM(test_abs_lat)
#Model diagnostics
sjPlot::plot_model(test_abs_lat,type="diag")
AIC(test_abs_lat)
```

##Pop. trends ~ abs. lat. * spat. pos
```{r}
test_abs_lat_sp=glmmTMB::glmmTMB(data=data,
formula=slope~abs_latitude_mean*spatial_pos+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_abs_lat_sp)
MuMIn::r.squaredGLMM(test_abs_lat_sp)
#Model diagnostics
sjPlot::plot_model(test_abs_lat_sp,type="diag")
#AIC
AIC(test_abs_lat_sp)
```

##pop. trends~vulnerability*shift velocity
```{r}
#Two-way interaction term
test_vul_shift=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*scale(Vulnerability)+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_vul_shift)
MuMIn::r.squaredGLMM(test_vul_shift)
#Model diagnostics
sjPlot::plot_model(test_vul_shift,type="diag")
performance::check_collinearity(test_vul_shift)
sjPlot::plot_model(
  test_vul_shift,
  terms=c("shift_of_min_sm","Vulnerability[10,88]"),
  type = "eff")
```

##pop. trends~vulnerability*shift velocity*spatial pos.
```{r}
#Two-way interaction term
test_vul_sp_shift=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*scale(Vulnerability)*spatial_pos+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_vul_sp_shift)
MuMIn::r.squaredGLMM(test_vul_sp_shift)
#Model diagnostics
sjPlot::plot_model(test_vul_sp_shift,type="diag")
performance::check_collinearity(test_vul_sp_shift)
sjPlot::plot_model(
  test_vul_sp_shift,
  terms=c("shift_of_min_sm","Vulnerability[10,88]","spatial_pos[-0.5,0,0.5]"),
  type = "eff")+
  theme_bw()
```

##Pop. trends ~ commercial level
```{r}
#model
test_pop_com=glmmTMB::glmmTMB(data=data,
formula=slope~commercial_two_level+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_pop_com)
MuMIn::r.squaredGLMM(test_pop_com)
#Model diagnostics
sjPlot::plot_model(test_pop_com,type="diag")
sjPlot::plot_model(test_pop_com,type="eff")
```

##Pop. trends ~ commercial level
```{r}
#model
test_pop_com_shift=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*spatial_pos*commercial_two_level+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_pop_com_shift)
MuMIn::r.squaredGLMM(test_pop_com_shift)
#Model diagnostics
performance::check_collinearity(test_pop_com_shift)
sjPlot::plot_model(test_pop_com_shift,type="diag")
sjPlot::plot_model(test_pop_com_shift,
                   type="eff",
                   terms=c("shift_of_min_sm","spatial_pos[-0.5,0,0.5]","commercial_two_level"))

sjPlot::plot_model(test_pop_com_shift,
                   type="eff",
                   terms =c("shift_of_min_sm",
                            "spatial_pos[-0.5,0,0.5]",
                           "commercial_two_level"))+
      scale_color_manual(values=c("red","green","blue"))+
  labs(y="Population trend (slope)",
       x="Shift (km/ year)",
       title="Commercial status",
       color="Spatial  position",
       fill="Relative position")+
  theme(strip.background = element_rect(
     color="black", fill="white"))+
  geom_hline(yintercept = 0,linetype="dashed")+
  geom_vline(xintercept = 0,linetype="dashed")+
  theme(strip.background = element_rect(
     color="black", fill="white"))+
  theme(panel.border = element_blank(), axis.line.y=element_line(color='purple'),
        panel.grid = element_line(size=0.3),
        axis.line.x = element_line(color='#ffb20a'),
        axis.text.y=element_text(size=10),
        axis.title = element_text(size=14),
        axis.text.x = element_text(size=10),
        title = element_text(size=16))+
  theme_bw()
```

#Spatial and temporal mismatch

##spatial mismatch
```{r}
test_spat_mis=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*scale(spatial_pos)*scale(mean_bt_bs_dist_of_min_sm)+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n) #weights = 1/se_slope_corr
#Model Summary
summary(test_spat_mis)
MuMIn::r.squaredGLMM(test_spat_mis)
#Model diagnostics
sjPlot::plot_model(test_spat_mis,type="diag")
performance::check_collinearity(test_spat_mis)
#plot
sjPlot::plot_model(test_spat_mis,type="eff",terms=c('shift_of_min_sm',"spatial_pos[-0.5,0,0.5]","mean_bt_bs_dist_of_min_sm[10,100,1000]"),pred.type = "re")
```

##Temporal mismatch
```{r}
test_tm=glmmTMB::glmmTMB(data=data,
formula=slope~shift_of_min_sm*spatial_pos*scale(mean_temporal_mismatch)+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n) #weights = 1/se_slope_corr
#Model Summary
summary(test_tm)
MuMIn::r.squaredGLMM(test_tm)
#Model diagnostics
sjPlot::plot_model(test_tm,type="diag")
performance::check_collinearity(test_tm)
#plot
sjPlot::plot_model(test_tm,type="eff",terms=c('shift_of_min_sm',"spatial_pos[-0.5,0,0.5]","mean_temporal_mismatch[-50,0,50]"),pred.type = "re")
```

