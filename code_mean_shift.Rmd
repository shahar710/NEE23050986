---
title: "code"
author: "Shahar Chaikin"
date: "7/20/2023"
output: html_document
---

This code presents the analyses used in NATECOLEVOL-23050986

#Packages
```{r}
library(tidyverse)
library(glmmTMB)
```

#Load the data
```{r}
data=read.csv("data.csv")
```

Set WD
```{r}
setwd("C:\\Users\\Belmaker-Video\\Desktop\\Shahar Chaikin\\on going research\\Depth and Biodiversity\\data\\abundance at range edge\\R\\organized_codes\\code_to_publish\\NATECOLEVOL-23050986")
```

Digits
```{r}
options(scipen=999)
```

#main effect
The relationship between population trends and range shift velocities.
Population trends (slopes) based on linear models with scaled abundance.
```{r}
test_main_effect=glmmTMB(data=data,
formula=slope~mean_shift+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_main_effect)
MuMIn::r.squaredGLMM(test_main_effect)
#Model diagnostics
sjPlot::plot_model(test_main_effect,type="diag")
sjPlot::plot_model(test_main_effect,type="eff",show.data = T)
#AIC
AIC(test_main_effect)
```

##remove extreme range shift velocities
```{r}
#shift of minimum sm
quantile(data$mean_shift)[[4]]
IQR=quantile(data$mean_shift)[[4]]-quantile(data$mean_shift)[[2]]
min=quantile(data$mean_shift)[[2]]-(IQR*1.5)
max=quantile(data$mean_shift)[[4]]+(IQR*1.5)

test_main_effect_rm_ex_sh=glmmTMB::glmmTMB(data=data %>% filter(mean_shift<=max & mean_shift>=min),
formula=slope~mean_shift+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n) 
#Model Summary
summary(test_main_effect_rm_ex_sh)
MuMIn::r.squaredGLMM(test_main_effect_rm_ex_sh)
#Model diagnostics
sjPlot::plot_model(test_main_effect_rm_ex_sh,type="diag")
sjPlot::plot_model(test_main_effect_rm_ex_sh,type="eff")
```

##species level
```{r}
#Create species level shift with stat. summary
species_level_shifts=data %>% 
  group_by(species) %>% 
  summarise(mean_mean_shift=mean(mean_shift),
            n=n(),
            sd=sd(mean_shift),
            se=(sd/sqrt(n)),
            moe=1.96*se,
            ci_high_shift=mean_mean_shift+moe,
            ci_low_shift=mean_mean_shift-moe)

#Create species level data
data_sp_level=data %>% 
  group_by(species,family) %>% 
  summarise(n_es=n(),
            mean_es=mean(slope),#weighted.mean(slope,w =n),
            sd_es=sd(slope),
            se_es=sd_es/sqrt(n_es),
            moe_es=se_es*1.96,
            ci_high_es=mean_es+moe_es,
            ci_low_es=mean_es-moe_es)  %>%
  inner_join(species_level_shifts,by="species") %>% 
  ungroup() %>% 
  mutate(across(c(4:10,12:16), round, 3),
         sqrt_n_es=sqrt(n_es))

#Model
#Model
test_sp_level=glmmTMB::glmmTMB(data=data_sp_level,
formula=mean_es~mean_mean_shift+
  (1|family),
family = 'gaussian',
weights =sqrt_n_es) #weights = 1/se_slope_corr
#Model Summary
summary(test_sp_level)
MuMIn::r.squaredGLMM(test_sp_level)
#Model diagnostics
sjPlot::plot_model(test_sp_level,type="diag")
sjPlot::plot_model(test_sp_level,type="eff",show.data = T)
```


#Spatial and thermal position

##The effect of spatial position
```{r}
test_spat_pos=glmmTMB::glmmTMB(data=data,
formula=slope~mean_shift*spatial_pos+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_spat_pos)
MuMIn::r.squaredGLMM(test_spat_pos)

#Model diagnostics
sjPlot::plot_model(test_spat_pos,type="diag")
performance::check_collinearity(test_spat_pos)
sjPlot::plot_model(test_spat_pos,type="int")
#AIC
AIC(test_spat_pos)
```

##the effect of thermal position
```{r}
test_therm_pos=glmmTMB::glmmTMB(data=data,
formula=slope~mean_shift*thermal_pos+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_therm_pos)
MuMIn::r.squaredGLMM(test_therm_pos)
#Model diagnostics
sjPlot::plot_model(test_therm_pos,type="diag")
performance::check_collinearity(test_therm_pos)
```

##pop. trends~vulnerability*shift velocity
```{r}
#Two-way interaction term
test_vul_shift=glmmTMB::glmmTMB(data=data,
formula=slope~mean_shift*scale(Vulnerability)+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_vul_shift)
MuMIn::r.squaredGLMM(test_vul_shift)
#Model diagnostics
sjPlot::plot_model(test_vul_shift,type="diag")
performance::check_collinearity(test_vul_shift)
sjPlot::plot_model(
  test_vul_shift,
  terms=c("mean_shift","Vulnerability[10,88]"),
  type = "eff")
```

##pop. trends~vulnerability*shift velocity*spatial pos.
```{r}
#Two-way interaction term
test_vul_sp_shift=glmmTMB::glmmTMB(data=data,
formula=slope~mean_shift*scale(Vulnerability)*spatial_pos+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n)
#Model Summary
summary(test_vul_sp_shift)
MuMIn::r.squaredGLMM(test_vul_sp_shift)
#Model diagnostics
sjPlot::plot_model(test_vul_sp_shift,type="diag")
performance::check_collinearity(test_vul_sp_shift)
sjPlot::plot_model(
  test_vul_sp_shift,
  terms=c("mean_shift","Vulnerability[10,88]","spatial_pos[-0.5,0,0.5]"),
  type = "eff")+
  theme_bw()
```

#Spatial and temporal mismatch

##spatial mismatch
```{r}
test_spat_mis=glmmTMB::glmmTMB(data=data,
formula=slope~mean_shift*scale(spatial_pos)*scale(mean_bt_bs_dist_of_min_sm)+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n) #weights = 1/se_slope_corr
#Model Summary
summary(test_spat_mis)
MuMIn::r.squaredGLMM(test_spat_mis)
#Model diagnostics
sjPlot::plot_model(test_spat_mis,type="diag")
performance::check_collinearity(test_spat_mis)
#plot
sjPlot::plot_model(test_spat_mis,type="eff",terms=c('mean_shift',"spatial_pos[-0.5,0,0.5]","mean_bt_bs_dist_of_min_sm[10,100,1000]"),pred.type = "re")
```

##Temporal mismatch
```{r}
test_tm=glmmTMB::glmmTMB(data=data,
formula=slope~mean_shift*spatial_pos*scale(mean_temporal_mismatch)+
  (1|family)+
  (1|study_id),
family = 'gaussian',
weights =sqrt_n) #weights = 1/se_slope_corr
#Model Summary
summary(test_tm)
MuMIn::r.squaredGLMM(test_tm)
#Model diagnostics
sjPlot::plot_model(test_tm,type="diag")
performance::check_collinearity(test_tm)
#plot
sjPlot::plot_model(test_tm,type="eff",terms=c('mean_shift',"spatial_pos[-0.5,0,0.5]","mean_temporal_mismatch[-50,0,50]"),pred.type = "re")
```

